---
layout:     post
title:      Charles抓包MapLocal返回数据截断问题
subtitle:   学习笔记
date:       2019-04-02
author:     HelloMin
header-img: img/post-bg-lemon.jpg
catalog: true
tags:
    - Tool
---

> Charles也算是前端开发必备工具了，用于模拟各种返回数据，抓包，都很方便。但昨天，我被Charles的一个小问题折腾了一天，最后发现果然不是什么大问题，记录一下，按照我搜索的关键词为本文命名，以防有其他人和我一样用这几个关键词组合搜不到结果。

### 现象
首先，发起一次成功的请求，保存请求的返回为文件。然后，将该请求MapLocal到保存后的文件，正常情况下，再次请求的效果应该和第一次请求一样。然而在实际操作中，发现使用MapLocal之后，请求的返回数据就总是不全，大部分都被截断了！

### 原因
我所使用的4.0.x的Charles中，这是个bug！更新到新版本Charles后，这个问题就不存在了！

### 现象
更新之后，使用MapLocal可以在Charles中看到完整的返回数据了。但是在Android本地代码中，依然返回了error，原因是IOException,再仔细看，发现是某个地址和另一个地址的数据不匹配。

```
IOException: ID1ID2: actual 0x00000a3c != expected 0x00001f8b
```

### 原因
在尝试解决问题1的时候，我使用Rewrite功能，对请求的返回进行了修改，添加了一些header参数，其中包括一个gzip参数，当时并没有细想它的意思，只是看到原始请求的返回数据有就加上了。正是这个参数导致了后来的问题。gzip参数代表了返回的数据是经过了压缩的，Android在收到数据之后，如果发现这个参数，应该会对返回数据进行解压，但实际上我MapLocal使用的数据已经是经过解压的完整数据了，对没有压缩的文件进行解压，自然会报错，把这个参数删除就好了。

### 总结
1. 任何软件都会有bug，不要因为Charles的优秀就只怀疑是自己用的不对，如果确认自己使用无误，确认下别的同事使用的版本，把自己的使用环境和别人进行对比，也许问题就在其中。
2. 搜索的关键词很重要。我一开始使用Charles json parse error进行搜索，并没有什么结果，之后是使用Charles返回的failure中的关键词进行搜索，才找到了和我有类似问题的人，发现他们是版本太老的问题，才终于找到了解决方式。
3. 做任何操作都要动脑子，虽然我尝试还原原请求，添加了它的所有参数，也属于无奈之举，但是gzip这种涉及到文件大小的参数，和content type这种格式参数还是有很大区别的，以后遇到类似问题要当心。
4. 最麻烦的问题往往是因为同一个现象有不同的原因，交织在一起才让人费解。